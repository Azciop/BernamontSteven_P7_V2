<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Groupomania</title>

    <script src="https://unpkg.com/vue@3"></script>
</head>

<body>
    <template id="app">
        <div>
            <h1 v-if="mode == 'login'">Connexion</h1>
            <h1 v-else>Inscription</h1>
            <p v-if="mode == 'login'" @click="switchToCreate()">Pas encore de compte? <span>Créer un compte ici</span>
            </p>
            <p v-else>Déjà utilisateur? <span @click="switchToLogin()">Connectez vous ici</span></p>
            <div>
                <input type="text" placeholder="Adresse e-mail">
            </div>
            <div v-if="mode == 'create'">
                <input v-model="prenom" type="text" placeholder="Prénom">
                <input v-model="nom" type="text" placeholder="Nom">
            </div>
            <div>
                <input v-model="password" type="password" placeholder="Mot de passe">
            </div>
            <div v-if="mode == 'login' && status == 'error_login'"> Adresse mail ou mot de passe invalide</div>
            <div v-if="mode == 'create' && status == 'error_create'"> Adresse mail déjà utilisée</div>
            <div>
                <button @click="login()" class="button" :class="{'button--disable' : !validatedFields()}"
                    v-if="mode == 'login'">
                    <span v-if="status == 'loading'">Connexion en cours</span>
                    <span v-else>Se connecter</span>
                </button>
                <button @click="createAccount()" class="button" :class="{'button--disable' : !validatedFields()}"
                    v-else>
                    <span v-if="status == 'loading'">Creation en cours</span>
                    <span v-else>Créer mon compte</span>
                </button>
            </div>
        </div>
    </template>

    <script>

        // import { mapState} from 'vuex'

        const vm = Vue.createApp({
            data: function () {
                return {
                    mode: 'login',
                    email: "",
                    prenom: "",
                    nom: "",
                    password: "",
                }
            },
            computed: {
                validatedFields: function () {
                    if (this.mode == 'create') {
                        if (this.email != "" && this.prenom != "" && this.nom != "" && this.password != "") {
                            return true;
                        } else {
                            return false;
                        }
                    } else {
                        if (this.email != "" && this.password != "") {
                            return true;
                        } else {
                            return false;
                        }
                    }
                },
                // ...mapState([status])
            },
            methods: {
                switchToCreate: function () {
                    this.mode = 'create';
                },
                switchToLogIn: function () {
                    this.mode = 'login';
                },
                login: function () {
                    const self = this;
                    this.$store.dispatch('login', {
                        email: this.email,
                        password: this.password,
                    }).then(function () {
                        self.$router.push('/main')
                    }), function (error) {
                        console.log(error);
                    }
                },
                createAccount: function () {
                    const self = this;
                    this.$store.dispatch('createAccount', {
                        email: this.email,
                        nom: this.nom,
                        prenom: this.prenom,
                        password: this.password,
                    }).then(function () {
                        self.login();
                    }), function (error) {
                        console.log(error);
                    }
                }
            }
        })

        const axios = require('axios');

        const instance = axios.create({
            baseURL: 'http://127.0.0.1:3000/api/'
        });
        const store = createStore({
            state: {
                status: '',
                user: {
                    userId: -1,
                    token: "",
                },
            },
            mutations: {
                setStatus: function (state, status) {
                    state.status = status;
                },
                logUser: function (state, suer) {
                    state.user = user;
                }
            },
            actions: {
                login: ({ commit }, userInfos) => {
                    commit('setStatus', 'loading');
                    return new Promise((resolve, reject) => {
                        instance.post('/auth/login', userInfos)
                            .then(function (response) {
                                commit('setStatus', '');
                                commit('logUser', response.data);
                                resolveresponse
                            })
                            .catch(function (error) {
                                commit('setStatus', 'error_login');
                                reject(error);
                            });
                    });
                },
                createAccount: ({ commit }, userInfos) => {
                    commit('setStatus', 'loading');
                    return new Promise((resolve, reject) => {
                        commit;
                        instance.post('/auth/signup', userInfos)
                            .then(function (response) {
                                commit('setStatus', 'created');
                                resolveresponse
                            })
                            .catch(function (error) {
                                commit('setStatus', 'error_create');
                                reject(error);
                            });
                    });
                }
            }
        });

    </script>
</body>

</html>